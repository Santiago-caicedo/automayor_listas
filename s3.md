# Configuración de AWS S3

## Bucket

| Atributo | Valor |
|----------|-------|
| **Nombre** | `vadomdata` |
| **Región** | `us-east-1` (o la configurada) |
| **URL base** | `https://vadomdata.s3.amazonaws.com/` |

---

## Arquitectura Multi-Cliente

Todos los clientes comparten el mismo bucket, separados por **prefijos (carpetas)**:

```
vadomdata/                          ← Bucket compartido
│
├── comertex/                       ← S3_CLIENT_PREFIX=comertex
│   ├── static/                     ← Archivos estáticos (CSS, JS, imágenes)
│   │   ├── css/
│   │   ├── js/
│   │   └── images/
│   └── media/                      ← Archivos subidos por usuarios
│       └── cargas_masivas/
│           └── empresa_{id}/
│               ├── subidas/        ← Excel de clientes
│               └── resultados/     ← PDF procesados
│
├── redpapaz/                       ← S3_CLIENT_PREFIX=redpapaz
│   ├── static/
│   └── media/
│
├── cliente_nuevo/                  ← S3_CLIENT_PREFIX=cliente_nuevo
│   ├── static/
│   └── media/
│
└── ...
```

---

## Configuración Híbrida (Local vs Producción)

El sistema detecta automáticamente el entorno basado en `DEBUG`:

| Entorno | DEBUG | Almacenamiento | URL Estáticos | URL Media |
|---------|-------|----------------|---------------|-----------|
| **Desarrollo** | `True` | Sistema de archivos local | `/static/` | `/media/` |
| **Producción** | `False` | AWS S3 | `https://vadomdata.s3.amazonaws.com/{prefix}/static/` | `https://vadomdata.s3.amazonaws.com/{prefix}/media/` |

### Flujo en Desarrollo (DEBUG=True)

```
Usuario solicita /static/css/style.css
         ↓
Django busca en: ./staticfiles/css/style.css (local)
         ↓
Responde desde el sistema de archivos
```

### Flujo en Producción (DEBUG=False)

```
Usuario solicita imagen
         ↓
Django genera URL: https://vadomdata.s3.amazonaws.com/redpapaz/static/css/style.css
         ↓
Navegador descarga directamente desde S3
```

---

## Variables de Entorno

```bash
# .env para desarrollo local
DEBUG=True
S3_CLIENT_PREFIX=micliente          # No se usa, pero debe estar

# .env para producción
DEBUG=False
S3_CLIENT_PREFIX=micliente          # Define la carpeta en S3
```

> **Nota:** No se requieren `AWS_ACCESS_KEY_ID` ni `AWS_SECRET_ACCESS_KEY`.
> El EC2 está vinculado directamente a S3 mediante **IAM Role**, por lo que boto3
> obtiene las credenciales automáticamente del metadata del servidor.

---

## Configuración en settings.py

```python
if DEBUG:
    # MODO DESARROLLO (LOCAL)
    STATIC_URL = '/static/'
    MEDIA_URL = '/media/'
    STORAGES = {
        "default": {"BACKEND": "django.core.files.storage.FileSystemStorage"},
        "staticfiles": {"BACKEND": "django.contrib.staticfiles.storage.StaticFilesStorage"},
    }
else:
    # MODO PRODUCCIÓN (S3)
    from storages.backends.s3boto3 import S3Boto3Storage

    # Configuración AWS (credenciales via IAM Role del EC2)
    AWS_STORAGE_BUCKET_NAME = 'vadomdata'
    AWS_S3_REGION_NAME = 'us-east-1'
    AWS_S3_CUSTOM_DOMAIN = f'{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com'
    AWS_DEFAULT_ACL = None

    S3_PREFIX = config('S3_CLIENT_PREFIX', default='default_prefix')

    class StaticStorage(S3Boto3Storage):
        location = f'{S3_PREFIX}/static'
        default_acl = None

    class MediaStorage(S3Boto3Storage):
        location = f'{S3_PREFIX}/media'
        default_acl = None

    STATIC_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/{S3_PREFIX}/static/'
    MEDIA_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/{S3_PREFIX}/media/'

    STORAGES = {
        "default": {"BACKEND": "config.settings.MediaStorage"},
        "staticfiles": {"BACKEND": "config.settings.StaticStorage"},
    }
```

---

## Comandos

### Subir estáticos a S3 (producción)

```bash
# Asegúrate de tener DEBUG=False en .env
python manage.py collectstatic --noinput
```

Esto sube los archivos a: `vadomdata/{S3_CLIENT_PREFIX}/static/`

### Desarrollo local

```bash
# Con DEBUG=True, collectstatic guarda en ./staticfiles/
python manage.py collectstatic
```

---

## Agregar Nuevo Cliente

1. **Configurar `.env` en el servidor:**
   ```bash
   S3_CLIENT_PREFIX=nuevocliente
   DEBUG=False
   ```

2. **Ejecutar collectstatic:**
   ```bash
   python manage.py collectstatic --noinput
   ```

3. **Verificar en S3:**
   ```
   vadomdata/nuevocliente/static/  ← Archivos subidos
   ```

---

## Credenciales AWS

El servidor EC2 tiene un **IAM Role** asignado que le da acceso directo al bucket S3.

**No se requieren variables de entorno para credenciales AWS.**

Boto3 obtiene las credenciales automáticamente del metadata del EC2 (`http://169.254.169.254/`).

---

## Permisos del Bucket (Política IAM)

El usuario/rol IAM necesita estos permisos:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::vadomdata",
                "arn:aws:s3:::vadomdata/*"
            ]
        }
    ]
}
```

---

## Troubleshooting

### Error: "AccessControlListNotSupported"
**Solución:** Ya configurado en settings.py:
```python
AWS_DEFAULT_ACL = None
```

### Estáticos no cargan en producción
1. Verificar `DEBUG=False`
2. Verificar credenciales AWS
3. Ejecutar `collectstatic`
4. Verificar que los archivos existan en S3

### Estáticos no cargan en desarrollo
1. Verificar `DEBUG=True`
2. Agregar a `urls.py`:
   ```python
   from django.conf import settings
   from django.conf.urls.static import static

   if settings.DEBUG:
       urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
       urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
   ```

---

## Resumen

| Concepto | Valor |
|----------|-------|
| Bucket | `vadomdata` (compartido) |
| Separación | Por prefijo (`S3_CLIENT_PREFIX`) |
| Desarrollo | Archivos locales (`DEBUG=True`) |
| Producción | AWS S3 (`DEBUG=False`) |
| Credenciales | IAM Role (automático, sin keys) |
| Comando deploy | `python manage.py collectstatic --noinput` |
